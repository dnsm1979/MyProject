{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- Подключение CSS библиотек в head -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<div class="starter-template text-center py-5 px-3"></div>

<div class="container">
  <h3 class="text-center">Новый Акт технического состояния оборудования</h3>
  <div class="card mb-3">
    <div class="card-body">
      <form action="{% url 'act_technical:act_edit' pk=object.id %}" method="post" id="act_edit">
        {% csrf_token %}
        <div class="row">
          <!-- Дата и представители -->
          <div class="col-md-6 mb-3">
            <label for="id_creation_date" class="form-label">Дата составления акта:</label>
            <input type="date" class="form-control" id="id_creation_date"
              value="{% if form.creation_date.value %}{{ form.creation_date.value|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}"
              name="creation_date" required>
            {% if form.creation_date.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.creation_date.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-6 mb-3">
            <label for="id_representative_1" class="form-label">Представитель ЛПУ 1:</label>
            <input type="text" class="form-control" id="id_representative_1"
              value="{{ form.representative_1.value|default_if_none:'' }}"
              name="representative_1">
            {% if form.representative_1.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.representative_1.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-6 mb-3">
            <label for="id_representative_2" class="form-label">Представитель ЛПУ 2:</label>
            <input type="text" class="form-control" id="id_representative_2"
              value="{{ form.representative_2.value|default_if_none:'' }}"
              name="representative_2">
            {% if form.representative_2.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.representative_2.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-6 mb-3">
            <label for="id_representative_3" class="form-label">Представитель ЛПУ 3:</label>
            <input type="text" class="form-control" id="id_representative_3"
              value="{{ form.representative_3.value|default_if_none:''  }}"
              name="representative_3">
            {% if form.representative_3.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.representative_3.errors }}</div>
            {% endif %}
          </div>

          <!-- ЛПУ и оборудование -->
          <div class="col-md-6 mb-3">
            <label for="id_lpu" class="form-label">ЛПУ:</label>
            <div class="input-group">
              <select name="lpu" id="id_lpu" class="form-control select2-lpu" data-url="{% url 'cards:get_lpu_options' %}">
                <option value="">Выберите ЛПУ</option>
                {% for lpu in form.lpu.field.queryset %}
                <option value="{{ lpu.id }}" 
                        {% if lpu.id == selected_lpu %}selected{% endif %}>
                  {{ lpu.name }}
                </option>
              {% endfor %}
              </select>
              
            </div>
            {% if form.lpu.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.lpu.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-6 mb-3">
            <label for="id_device" class="form-label">Оборудование:</label>
            <div class="input-group">
              <select name="device" id="id_device" class="form-control select2-device" 
                      data-url="{% url 'cards:get_devices_by_lpu' %}">
                      {% if selected_lpu %}
                      {% for device in form.device.field.queryset %}
                        <option value="{{ device.id }}" 
                                {% if device.id == selected_device %}selected{% endif %}>
                          {{ device.name }}
                        </option>
                      {% endfor %}
                    {% else %}
                      <option value="">Сначала выберите ЛПУ</option>
                    {% endif %}
              </select>
              
            </div>
            {% if form.device.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.device.errors }}</div>
            {% endif %}
          </div>

          <!-- Текстовые поля -->
          <div class="col-md-12 mb-3">
            <label for="id_check_result" class="form-label">Результаты проверки оборудования:</label>
            <textarea class="form-control" id="id_check_result" rows="3"
              name="check_result" required>{{ form.check_result.value|default_if_none:'' }}</textarea>
            {% if form.check_result.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.check_result.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-12 mb-3">
            <label for="id_probable_cause" class="form-label">Вероятные причины неисправности:</label>
            <textarea class="form-control" id="id_probable_cause" rows="3"
              name="probable_cause">{{ form.probable_cause.value|default_if_none:'' }}</textarea>
            {% if form.probable_cause.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.probable_cause.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-12 mb-3">
            <label for="id_conclusion" class="form-label">Заключение:</label>
            <textarea class="form-control" id="id_conclusion" rows="3"
              name="conclusion" required>{{ form.conclusion.value|default_if_none:'' }}</textarea>
            {% if form.conclusion.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.conclusion.errors }}</div>
            {% endif %}
          </div>

          <!-- Форма загрузки изображений -->
          <form method="post" enctype="multipart/form-data" action="{% url 'act_technical:act_update' pk=actt.pk %}">
            {% csrf_token %}
            
            <div class="mb-3">
              <label class="form-label">Добавить изображения</label>
              <input type="file" 
                    class="form-control" 
                    name="images" 
                    multiple 
                    accept="image/*">
            </div>
            
            <div class="mb-3">
              <label class="form-label">Описание (необязательно)</label>
              <input type="text" 
                    class="form-control" 
                    name="description">
            </div>
            
            <button type="submit" class="btn btn-primary">
              Загрузить изображения
            </button>
          </form>

 
          <!-- Галерея изображений -->
          <div class="row mt-4">
            {% for image in images %}
            <div class="col-md-4 mb-4">
              <div class="card">
                <img src="{{ image.image.url }}" 
                    class="card-img-top" 
                    alt="Изображение акта">
                <div class="card-body">
                  <p class="card-text">
                    {{ image.description|default:"Без описания" }}
                  </p>
                  <small class="text-muted">
                    {{ image.uploaded_at|date:"d.m.Y H:i" }}
                  </small>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="col-12">
              <div class="alert alert-info">
                Нет загруженных изображений
              </div>
            </div>
            {% endfor %}
          </div>
                <a class="btn btn-primary ms-2" href="{% url 'act_technical:act_update' pk=actt.id %}" role="button">
        <i class="fas fa-copy"></i> Добавить изображения
      </a>

          <!-- Кнопка отправки -->
          <div class="col-12 mt-3">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-file-alt"></i> Сохранить изменения
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Подключение JS библиотек в конце body -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="{% static 'js/upload.js' %}"></script>

<script>
$(document).ready(function() {
  // Инициализация Select2 для ЛПУ
  $('.select2-lpu').select2({
    placeholder: "Выберите ЛПУ",
    allowClear: true,
    width: '100%'
  });

  // Инициализация Select2 для оборудования
  $('.select2-device').select2({
    placeholder: "Выберите оборудование",
    allowClear: true,
    width: '100%',
    {% if not form.lpu.value %}disabled: true,{% endif %}
    ajax: {
      url: $('.select2-device').data('url'),
      dataType: 'json',
      delay: 250,
      data: function(params) {
        return {
          q: params.term, // поисковый запрос
          lpu_id: $('#id_lpu').val() // ID выбранного ЛПУ
        };
      },
      processResults: function(data) {
        return {
          results: data.results
        };
      },
      cache: true
    }
  });

  // Обработчик изменения ЛПУ
  $('#id_lpu').change(function() {
    var lpuId = $(this).val();
    var deviceSelect = $('#id_device');
    
    if (lpuId) {
      // Активируем поле оборудования
      deviceSelect.prop('disabled', false);
      
      // Очищаем и обновляем список оборудования
      deviceSelect.val(null).trigger('change');
      
      // Обновляем ссылку для добавления нового оборудования
      $('#add-equipment-btn').attr('href', "{% url 'cards:add_hardware' %}?lpu_id=" + lpuId);
    } else {
      // Деактивируем поле оборудования
      deviceSelect.prop('disabled', true).val(null).trigger('change');
    }
  });

  // Инициализация при загрузке, если ЛПУ уже выбрано
  if ($('#id_lpu').val()) {
    $('#add-equipment-btn').attr('href', "{% url 'cards:add_hardware' %}?lpu_id=" + $('#id_lpu').val());
  }

  // Автоматическое заполнение текущей даты
  const dateField = document.getElementById('id_creation_date');
  if (dateField && !dateField.value) {
    const today = new Date();
    dateField.value = today.toISOString().substr(0, 10);
  }
});
</script>


<style>
.bi.spin {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>

<style>
  .input-group-text {
    min-width: 40px;
    justify-content: center;
  }
  textarea.form-control {
    min-height: 120px;
  }
</style>

{% endblock %}