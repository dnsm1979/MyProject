{% extends "base.html" %}
{% load static %}
{% block content %}
{% load bootstrap5 %} {% bootstrap_css %} {% bootstrap_javascript %} 
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<div class="print-content">
<!-- Основной контент акта -->
<div class="starter-template text-center py-4 px-3"></div>
<div class="container act-print-container">
    <div class="container">
        <div class="row row-custom">
          <div class="col-4 text-start">
            <p class="text-center">{{actt.lpu.name}}</p>
            <p class="text-center">{{actt.lpu.index}}, {{actt.lpu.zip}}, г. {{actt.lpu.city}}, {{actt.lpu.adress}}</p>
            <p class="text-center">Тел. {{actt.lpu.phone}}</p>
          </div>
          <div class="col-4 text-end"></div>
          <div class="col">
            <p class="fs-6 text-center">АО ПТП «Медтехника»</p>
            <p class="text-center">620085, г. Екатеринбург,</p>
            <p class="text-center"> ул. Учителей, д. 30</p>
            <p class="text-center">Тел. (343) 380-80-70</p>
          </div>
        </div>
        
        <div class="starter-template text-center py-4 px-3"></div>
        
        <div class="row row-date">
          <div class="col-3">
            <p class="text-center text-decoration-underline">г. {{actt.lpu.city}}</p>
          </div>
          <div class="col-6"></div>
          <div class="col-3">
            <p class="text-center text-decoration-underline">Дата: {{actt.creation_date|date:"d.m.Y\г."}}</p>
          </div>
        </div>
      
        <div class="row head-container">
          <h4 class="text-center">АКТ № ____</h4>
          <h6 class="text-center fw-bold">технического состояния медицинской техники</h6>
        </div>
        
        <div class="row">
          <div class="col">
            <p class="text-start fw-bold">Комиссия в составе:</p>
          </div>
        </div>
      
        <div class="row">
          <div class="col-auto">
            <p class="text-start">Инженера сервисного центра:</p>
          </div>
          <div class="col-auto">
            <p class="text-end fst-italic text-decoration-underline">{{actt.user.last_name}} {{actt.user.first_name}} {{actt.user.surname}}</p>
          </div>
        </div>
        
        <div class="row">
          <div class="col-auto">
            <p class="text-start">Главного инженера сервисного центра:</p>
          </div>
          <div class="col-auto">
            <p class="text-end fst-italic text-decoration-underline">{{ leader.last_name }} {{ leader.first_name }} {{ leader.surname }}</p>
          </div>
        </div>
        
        <div class="row">
          <div class="col">
            <p class="text-start">
              с участием представителя учреждения / владельца
              _______________________________________
            </p>
          </div>
        </div>
        
        <div class="row">
          <div class="col">
            <p class="text-start">Проверила техническое состояние: {{actt.device.name}}</p>
          </div>
        </div>
      
        <div class="row">
          <div class="col-auto">
            <p class="text-start">Модель:</p>
          </div>
          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.device.model}}</p>
          </div>
          <div class="col-auto">
            <p class="text-start">заводской номер:</p>
          </div>
          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.device.serial_number}}</p>
          </div>
        </div>
        
        <div class="row">
          <div class="col-auto">
            <p class="text-start">завод-изготовитель:</p>
          </div>
          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.device.manufacturer}}</p>
          </div>
          <div class="col-auto">
            <p class="text-start">страна:</p>
          </div>
          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.device.country}}</p>
          </div>
        </div>
        
        <div class="row">
          <div class="col-auto">
            <p class="text-start">дата изготовления:</p>
          </div>
          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.device.year_of_manufacture}}</p>
          </div>
          <div class="col-auto">
            <p class="text-start">дата продажи:</p>
          </div>
          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.device.year_of_sale}}</p>
          </div>
        </div>
        
        <div class="row">
          <div class="col-auto">
            <p class="text-start">дата ввода в эксплуатацию:</p>
          </div>
          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.device.commissioning_date}}</p>
          </div>
        </div>
        
        <div class="starter-template text-center py-2 px-1"></div>
        
        <div class="row row-description">
          <div class="col-auto">
            <p class="text-start fw-bold">При проверке изделия медицинской техники установлено:</p>
          </div>
        
        
      
          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.check_result}}</p>
          </div>
       
        </div>
        <div class="starter-template text-center py-2 px-1"></div>
        
        <div class="row row-description">
          <div class="col-auto">
            <p class="text-start fw-bold">Вероятные причины:</p>
          </div>

          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.probable_cause}}</p>
          </div>
        </div>
        
        <div class="starter-template text-center py-2 px-1"></div>
        
        <div class="row row-description">
          <div class="col-auto">
            <p class="text-start fw-bold">Заключение комиссии:</p>
          </div>

          <div class="col-auto">
            <p class="text-start fst-italic text-decoration-underline">{{actt.conclusion}}</p>
          </div>
        </div>
        
        <div class="row row-small-text" style="font-size: 8px">
          <div class="col-12">
            <p class="text-start lh-sm">Отпечатано в 2-х экземплярах:</p>
          </div>
          <div class="col-12">
            <p class="text-start lh-sm">1. Учреждению /владельцу –1 экз.;</p>
          </div>
          <div class="col">
            <p class="text-start lh-sm">2. Предприятию технического сервиса –1 экз.;</p>
          </div>
        </div>
        
        <div class="row">
          <div class="col-auto">
            <p class="text-start">Представители АО «ПТП «Медтехника»:</p>
          </div>
        </div>
        
        <div class="row row-agent">
          <div class="col-7">
            <p class="text-end">Инженер сервисного центра</p>
          </div>
          <div class="col-3">
            <p class="text-end">_____________</p>
          </div>
          <div class="col-2">
            <p class="text-start fst-italic text-decoration-underline">{{actt.user.last_name}} {{actt.user.first_name|first}} {{actt.user.surname|first}}</p>
          </div>
        </div>
        
        <div class="row row-agent">
          <div class="col-7">
            <p class="text-end">Главный инженер сервисного центра</p>
          </div>
          <div class="col-3">
            <p class="text-end">_____________</p>
          </div>
          <div class="col-2">
            <p class="text-start fst-italic text-decoration-underline">{{ leader.last_name }} {{ leader.first_name|first }} {{ leader.surname|first }}</p>
          </div>
        </div>
        
        <div class="starter-template text-center py-4 px-3"></div>
        
        <div class="row">
          <div class="col-auto">
            <p class="text-start">Представители учреждения /владельца:</p>
          </div>
        </div>
        
        <div class="row row-agent">
          <div class="col-7">
            <p class="text-end">__________________________________________</p>
          </div>
          <div class="col-3">
            <p class="text-end">_____________</p>
          </div>
          <div class="col-2">
            <p class="text-start">_____________________</p>
          </div>
        </div>
        
        <div class="row row-agent">
          <div class="col-7">
            <p class="text-end">__________________________________________</p>
          </div>
          <div class="col-3">
            <p class="text-end">_____________</p>
          </div>
          <div class="col-2">
            <p class="text-start">_____________________</p>
          </div>
        </div>
      </div>
</div>
</div>

<!-- Кнопки действий (не печатаются) -->
<div class="container mt-4 no-print">
  <div class="row">
    <div class="col">
      <div class="d-flex flex-wrap gap-2 align-items-center">  <!-- Добавлен align-items-center -->
        <!-- Основные кнопки -->
        <a class="btn btn-primary" href="{% url 'act_technical:act_edit' pk=actt.id %}">
          <i class="fas fa-edit"></i> Редактировать
        </a>
        <a class="btn btn-primary" href="{% url 'act_technical:act_edit2' pk=actt.id %}">
          <i class="fas fa-copy"></i> Сохранить как новый
        </a>
        <button type="button" class="btn btn-secondary" onclick="printAct()">
          <i class="fas fa-print"></i> Печать
        </button>
        <a href="{% url 'act_technical:act_pdf' pk=actt.id %}" class="btn btn-info">
          <i class="fas fa-file-pdf"></i> PDF
        </a>
        
        <!-- Кнопка управления комментариями -->
        <div class="d-inline-block">  <!-- Обертка для фиксации позиции -->
          <button id="toggleCommentsBtn" class="btn btn-outline-secondary">
            <i class="fas fa-comments"></i> Комментарии
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Форма комментариев (не печатается) -->
<div class="no-print">
  <div class="container mt-4" id="commentsSection">
    <div id="commentsContainer">
      <div class="comments-section">
        {% for comment in comments %}
        <div class="comment-item mb-3 p-3 border rounded {% if not comment.active %}comment-inactive{% endif %}" 
             data-comment-id="{{ comment.id }}" 
             data-is-active="{{ comment.active|yesno:'true,false' }}">
          <div class="comment-text">
            {{ comment.text|linebreaksbr }}
          </div>
          <div class="comment-meta text-muted small mt-2">
            <span class="comment-author">
              <i class="fas fa-user"></i> {{ comment.user.get_full_name|default:comment.user.username }}
            </span>
            <span class="comment-date ms-3">
              <i class="far fa-clock"></i> {{ comment.created_at|date:"d.m.Y H:i" }}
            </span>
            {% if not comment.active %}
            <span class="comment-status ms-3 text-success">
              <i class="fas fa-check-square"></i> Выполнен!
            </span>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <div class="no-comments text-muted">Пока нет комментариев</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
      
      <form method="post" action="{% url 'act_technical:add_comment_to_act' actt.id %}">
        {% csrf_token %}
        <div class="mb-3">
          <textarea class="form-control" name="comment" rows="3"
                    placeholder="Введите ваш комментарий здесь..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Сохранить комментарий
        </button>
      </form>
    </div>
  </div>
</div>


    <!-- Контейнер с изображениями -->
  <div class="row" id="imageGallery">
    {% for image in actt.images.all %}
    <div class="col-md-4 mb-4 image-item" data-id="{{ image.id }}">
      <div class="card h-100">
        <img src="{{ image.image.url }}" 
             class="card-img-top img-thumbnail cursor-zoom image-card" 
             alt="Изображение акта"
             data-bs-toggle="modal" 
             data-bs-target="#imageModal"
             data-img-src="{{ image.image.url }}"
             data-img-desc="{{ image.description|default:'Без описания' }}">
        <div class="card-body d-flex flex-column">
          <p class="card-text">{{ image.description|default:"Без описания" }}</p>
          <div class="mt-auto">
            <small class="text-muted d-block">
              <i class="far fa-clock"></i> {{ image.uploaded_at|date:"d.m.Y H:i" }}
            </small>

          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="alert alert-info">
        Нет загруженных изображений
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Модальное окно для просмотра изображений -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalImageTitle">Просмотр изображения</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" id="modalImageContent" class="img-fluid" alt="Увеличенное изображение">
        <p class="mt-2 text-muted" id="modalImageDesc"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Закрыть
        </button>
        <a href="#" class="btn btn-primary" id="downloadImageBtn">
          <i class="fas fa-download"></i> Скачать
        </a>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<!-- Скрипт для печати -->
<script>
  function printAct() {
    // Клонируем контейнер акта
    const originalContent = document.querySelector('.act-print-container');
    const printContent = originalContent.cloneNode(true);
    
    // Удаляем ненужные элементы
    printContent.querySelectorAll('.no-print').forEach(el => el.remove());
    
    // Создаем окно для печати
    const printWindow = window.open('', '_blank');
    
    // HTML для печати с сохранением структуры
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Акт №{{ actt.id }}</title>
        <meta charset="UTF-8">
        <style>
          @page {
            size: A4 portrait;
            margin: 10mm 5mm;
          }
          body {
            margin: 0;
            padding: 0;
            font-family: "Times New Roman", serif;
            font-size: 14pt;
            line-height: 1.1;
          }
          .container {
            width: 100%;
            padding: 5px;
          }

          .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 15px;
            page-break-inside: avoid;
            }
          .row-custom{
            display: flex;
            flex-wrap: wrap;
            margin-right: -35px;
            margin-left: 15px;
            margin-bottom: 20px;
            margin-top: 20px;
            }
          .row-date {
            display: flex;
            flex-wrap: wrap;
            margin-right: 15px;
            margin-left: 15px;
            margin-bottom: 40px;
            margin-top: 40px;
            }
          .head-container{
            display: flex;
            flex-wrap: wrap;
            margin-right: 15px;
            margin-left: 120px;
            margin-bottom: 40px;
            margin-top: 40px;
          }
          .row-description{
            display: flex;
            flex-wrap: wrap;
            margin-right: 15px;
            margin-left: 15px;
            margin-bottom: 20px;
            margin-top: 20px;
          }
          .row-small-text{
            display: flex;
            flex-wrap: wrap;
            margin-right: 15px;
            margin-left: 15px;
            margin-bottom: 20px;
            margin-top: 20px;
            }
          .row-agent{
            display: flex;
            flex-wrap: wrap;
            margin-right: 0px;
            margin-left: 0px;
            margin-bottom: 10px;
            margin-top: 10px;
          }
          .comment-item {
    background-color: #f8f9fa;
  }
  .comment-text {
    white-space: pre-line; /* Сохраняет переносы строк */
  }
          .col-1, .col-2, .col-3, .col-4, .col-5, .col-6, 
          .col-7, .col-8, .col-9, .col-10, .col-11, .col-12 {
            padding: 0 5px;
            box-sizing: border-box;
          }
          .col-1 { width: 8.33%; }
          .col-2 { width: 16.66%; }
          .col-3 { width: 25%; }
          .col-4 { width: 33.33%; }
          .col-5 { width: 41.66%; }
          .col-6 { width: 50%; }
          .col-7 { width: 58.33%; }
          .col-8 { width: 66.66%; }
          .col-9 { width: 75%; }
          .col-10 { width: 83.33%; }
          .col-11 { width: 91.66%; }
          .col-12 { width: 100%; }
          p {
            margin-right: 15px;
            margin-bottom: 2px;
            margin-top: 0px;
            padding: 0px;
          }
          h4 { font-size: 18pt; margin: 5px 0; }
          h6 { font-size: 14pt; margin: 8px 0; }
          .text-center { text-align: center; }
          .text-start { text-align: left; }
          .text-end { text-align: right; }
          .text-decoration-underline { text-decoration: underline; }
          .fw-bold { font-weight: bold; }
          .fst-italic { font-style: italic; }
          .starter-template { height: 2px; }
        </style>
      </head>
      <body>
        ${printContent.innerHTML}
        <script>
          setTimeout(() => {
            window.print();
            setTimeout(window.close, 300);
          }, 200);
        <\/script>
      </body>
      </html>
    `);
    printWindow.document.close();
  }
  </script>
  <script>
        // Обработчик клика по изображению для открытия модального окна
      $(document).on('click', '.card-img-top', function() {
        const imgSrc = $(this).attr('src');
        const imgAlt = $(this).attr('alt');
        
        $('#modalImage').attr('src', imgSrc).attr('alt', imgAlt);
        $('#downloadImage').attr('href', imgSrc).attr('download', imgAlt || 'image');
      });
        // Инициализация модального окна для просмотра изображений
document.addEventListener('DOMContentLoaded', function() {
  const imageModal = document.getElementById('imageModal');
  if (imageModal) {
    imageModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const imgSrc = button.getAttribute('data-img-src');
      const imgDesc = button.getAttribute('data-img-desc');
      
      document.getElementById('modalImageContent').src = imgSrc;
      document.getElementById('modalImageTitle').textContent = imgDesc;
      document.getElementById('modalImageDesc').textContent = imgDesc;
      document.getElementById('downloadImageBtn').href = imgSrc;
      document.getElementById('downloadImageBtn').download = imgDesc || 'image';
    });
  }
      // Для динамически добавленных изображений
      function createImageCard(image) {
        return `
          <div class="col-md-4 mb-4 image-item" data-id="${image.id}">
            <div class="card image-card">
              <img src="${image.url}" class="card-img-top" alt="Изображение акта" style="cursor: pointer">
              <div class="card-body">
                <p class="card-text">${image.description || 'Без описания'}</p>
                <small class="text-muted">${new Date(image.uploaded_at).toLocaleString()}</small>
                <button class="btn btn-sm btn-danger delete-image mt-auto" data-id="${image.id}">
                  <i class="fas fa-trash"></i> Удалить
                </button>
              </div>
            </div>
          </div>
        `;
      }
});
    </script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.getElementById('toggleCommentsBtn');
  const commentsSection = document.getElementById('commentsSection');
  
  if (toggleBtn && commentsSection) {
    toggleBtn.addEventListener('click', function() {
      if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-comments"></i> Комментарии';
        toggleBtn.classList.replace('btn-outline-primary', 'btn-outline-secondary');
      } else {
        commentsSection.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-comments"></i> Комментарии';
        toggleBtn.classList.replace('btn-outline-secondary', 'btn-outline-primary');
      }
    });
  }
});
</script>
  <style>
  /* Стили для экрана */
  @media screen {
    .act-print-container {
      max-width: 210mm;
      margin: 20px auto;
      padding: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .no-print {
      max-width: 210mm;
      margin: 20px auto;
    }
  }
  /* Стили для карточек с изображениями */
  .image-card {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .image-card .card-img-top {
    width: 100%;
    height: 200px; /* Фиксированная высота для всех изображений */
    object-fit: cover; /* Сохраняет пропорции, обрезая лишнее */
    object-position: center; /* Центрирует изображение */
  }
  
  .image-card .card-body {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  
  .image-gallery {
    margin-top: 20px;
  }
  .card-img-top {
  cursor: pointer;
  transition: transform 0.2s;
}

.card-img-top:hover {
  transform: scale(1.02);
}
/* Дополнительные стили для кнопок */
.d-flex.flex-wrap {
  gap: 0.5rem;
}

.btn-outline-secondary {
  border-color: #6c757d;
  color: #6c757d;
}

.btn-outline-primary {
  border-color: #0d6efd;
  color: #0d6efd;
}

.comments-section {
  transition: all 0.3s ease;
}

@media (max-width: 768px) {
  .d-flex.flex-wrap {
    flex-direction: column;
    align-items: flex-start;
  }
}
/* Фиксируем высоту контейнера кнопок */
.no-print .container.mt-4 {
  min-height: 50px;
}

/* Плавное скрытие/показ */
#commentsSection {
  transition: all 0.3s ease;
}

/* Адаптивность */
@media (max-width: 768px) {
  .d-flex.flex-wrap {
    gap: 0.5rem;
  }
}
.comment-inactive .comment-text {
  opacity: 0.6;
  color: #6c757d;
}
.comment-inactive {
  background-color: #f8f9fa;
  border-color: #dee2e6 !important;
}
  </style>
  

{% endblock %}