{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="starter-template text-center py-5 px-3"></div>

<div class="container">
  <h3 class="text-center">Новая карточка ЛПУ</h3>
  <div class="card mb-3">
    <div class="card-body">
      <form action="{% url 'cards:add_lpu' %}" method="post" id="add_lpu">
        {% csrf_token %}
        <div class="row">
          <!-- Основная информация -->
          <div class="col-md-6 mb-3">
            <label for="id_name" class="form-label">Название:</label>
            <input type="text" class="form-control" id="id_name"
              value="{{ form.name.value|default_if_none:'' }}" name="name" required>
            {% if form.name.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.name.errors }}</div>
            {% endif %}
          </div>

          <!-- Поле города с возможностью добавления нового -->
          <div class="col-md-6 mb-3">
            <label for="id_city" class="form-label">Город:</label>
            <select name="city" id="id_city" class="form-control select2" data-allow-new="true" data-model="city" data-url="{% url 'cards:add_city_ajax' %}">
              <option value="">Выберите город</option>
              {% for city_item in city %}
              <option value="{{ city_item.id }}" 
                {% if form.city.value == city_item.id|stringformat:"s" %}selected{% endif %}>
                {{ city_item.city }}
              </option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">Если города нет в списке, введите новое название</small>
            {% if form.city.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.city.errors }}</div>
            {% endif %}
          </div>

          <!-- Адресные данные -->
          <div class="col-md-6 mb-3">
            <label for="id_index" class="form-label">Индекс:</label>
            <input type="text" class="form-control" id="id_index"
              value="{{ form.index.value|default_if_none:'' }}" name="index" required>
            {% if form.index.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.index.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-6 mb-3">
            <label for="id_adress" class="form-label">Адрес (улица, строение):</label>
            <input type="text" class="form-control" id="id_adress"
              value="{{ form.adress.value|default_if_none:'' }}" name="adress" required>
            {% if form.adress.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.adress.errors }}</div>
            {% endif %}
          </div>

          <!-- Поле области с возможностью добавления нового -->
          <div class="col-md-6 mb-3">
            <label for="id_zip" class="form-label">Область (республика, край):</label>
            <select name="zip" id="id_zip" class="form-control select2" data-allow-new="true" data-model="zip" data-url="{% url 'cards:add_region_ajax' %}">
              <option value="">Выберите область</option>
              {% for zip_item in zip_name %}
              <option value="{{ zip_item.id }}" 
                {% if form.zip.value == zip_item.id|stringformat:"s" %}selected{% endif %}>
                {{ zip_item.zip }}
              </option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">Если области нет в списке, введите новое название</small>
            {% if form.zip.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.zip.errors }}</div>
            {% endif %}
          </div>

          <!-- Контактная информация -->
          <div class="col-md-6 mb-3">
            <label for="id_phone" class="form-label">Телефон:</label>
            <input type="tel" class="form-control" id="id_phone"
              value="{{ form.phone.value|default_if_none:'' }}" name="phone">
            {% if form.phone.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.phone.errors }}</div>
            {% endif %}
          </div>

          <!-- Представители -->
          <div class="col-md-6 mb-3">
            <label for="id_representative_1" class="form-label">Представитель ЛПУ 1:</label>
            <input type="text" class="form-control" id="id_representative_1"
              value="{{ form.representative_1.value|default_if_none:'' }}" name="representative_1" placeholder="Не обязательно">
            {% if form.representative_1.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.representative_1.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-6 mb-3">
            <label for="id_representative_2" class="form-label">Представитель ЛПУ 2:</label>
            <input type="text" class="form-control" id="id_representative_2"
              value="{{ form.representative_2.value|default_if_none:'' }}" name="representative_2" placeholder="Не обязательно">
            {% if form.representative_2.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.representative_2.errors }}</div>
            {% endif %}
          </div>

          <div class="col-md-6 mb-3">
            <label for="id_representative_3" class="form-label">Представитель ЛПУ 3:</label>
            <input type="text" class="form-control" id="id_representative_3"
              value="{{ form.representative_3.value|default_if_none:'' }}" name="representative_3" placeholder="Не обязательно">
            {% if form.representative_3.errors %}
            <div class="alert alert-danger alert-dismissible fade show">{{ form.representative_3.errors }}</div>
            {% endif %}
          </div>

          <!-- Кнопка отправки -->
          <div class="col-12 mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Создать карточку</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Подключение Select2 -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Инициализация Select2 для всех полей с классом select2
    $('.select2').each(function() {
        var allowNew = $(this).data('allow-new') === true;
        
        $(this).select2({
            placeholder: "Выберите или введите новое значение",
            allowClear: true,
            width: '100%',
            tags: allowNew,
            language: {
                noResults: function() {
                    return allowNew ? "Нажмите Enter, чтобы добавить новое значение" : "Ничего не найдено";
                }
            },
            createTag: allowNew ? function (params) {
                return {
                    id: params.term,
                    text: params.term + ' (новый)',
                    newOption: true
                }
            } : undefined
        });
    });

    // Обработка добавления новых значений
    $('.select2[data-allow-new="true"]').on('select2:select', function (e) {
        var data = e.params.data;
        if (data.newOption) {
            var select = $(this);
            var model = select.data('model');
            var url = select.data('url');
            
            // Отправляем новое значение на сервер
            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    'name': data.text.replace(' (новый)', ''),
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    // Создаем новый option с полученным ID
                    var newOption = new Option(response.name, response.id, true, true);
                    select.append(newOption).trigger('change');
                    
                    // Обновляем значение выбранным ID
                    select.val(response.id).trigger('change');
                },
                error: function(xhr) {
                    alert('Ошибка при сохранении нового значения');
                    select.val(null).trigger('change');
                }
            });
        }
    });
});
</script>
{% endblock %}